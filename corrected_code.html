<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRHS Volunteer Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    // This sets 'Inter' as the default font
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom style for the message box */
        #message-box {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        
        /* Add styles for table scrolling */
        .table-wrapper {
            max-height: 60vh; /* Adjust height as needed */
            overflow-y: auto;
        }
        
        /* Sticky header for table */
        thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb; /* bg-gray-50 */
            z-index: 10;
        }
    </style>
</head>
<body class="h-full font-sans antialiased text-gray-900">

    <!-- Global Container -->
    <div class="flex flex-col min-h-screen">

        <!-- Header -->
        <header class="bg-white shadow-sm">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex-shrink-0 flex items-center">
                        <!-- Custom Logo Placeholder -->
                        <img src="hrhs.png" alt="HRHS Volunteer Portal Logo" class="h-8 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/100x32/6366f1/ffffff?text=HRHS';">
            
                        <span class="ml-2 text-xl font-semibold text-gray-800">HRHS Volunteer Portal</span>
                    </div>
                    <div id="logout-button-container" class="hidden flex items-center space-x-2">
                        <!-- DELETE BUTTON -->
                        <button id="delete-account-button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Delete My Account
                        </button>
                        <!-- LOGOUT BUTTON -->
                        <button id="logout-button" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Logout
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- Auth Container (Login/Registration) -->
            <div id="auth-container" class="mx-auto w-full max-w-lg mt-12">
                
                <!-- Login View (DEFAULT PAGE) -->
                <div id="login-view" class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
                    <div class="sm:mx-auto sm:w-full sm:max-w-md mb-6 text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900">
                            Sign in to your account
                        </h2>
                         <p class="mt-2 text-sm text-gray-600">
                           Use your registered Email and Password.
                        </p>
                    </div>

                    <form id="login-form" class="space-y-6">
                         <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email address</label>
                            <div class="mt-1">
                                <input id="email" name="email" type="email" autocomplete="email" required 
                                    class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    placeholder="Enter your registered email">
                            </div>
                        </div>

                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <div class="mt-1">
                                <input id="password" name="password" type="password" autocomplete="current-password" required 
                                    class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    placeholder="Enter your password">
                            </div>
                        </div>

                         <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                            </div>

                            <div class="text-sm">
                                <a href="#" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot password?</a>
                            </div>
                        </div>

                        <div>
                            <button type="submit" id="login-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                Sign In
                            </button>
                            <p id="auth-status" class="mt-4 p-3 bg-red-100 border border-red-300 rounded-md text-sm text-red-800 font-semibold hidden"></p>
                        </div>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            New volunteer? 
                            <a href="#" id="show-register-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                                Register here.
                            </a>
                        </p>
                    </div>
                </div>
                
                <!-- Registration View (Initially hidden) -->
                <div id="register-view" class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10 hidden">
                    <div class="sm:mx-auto sm:w-full sm:max-w-md mb-6 text-center">
                        <h2 class="text-3xl font-extrabold text-gray-900">
                            Register as a Volunteer
                        </h2>
                        <p class="mt-2 text-sm text-gray-600">
                            Your details will be used to track your hours.
                        </p>
                    </div>
                    
                    <form id="register-form" class="space-y-6">
                        <div class="grid grid-cols-1 gap-y-6 sm:grid-cols-2 sm:gap-x-8">
                            <div>
                                <label for="reg-full-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="reg-full-name" required 
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="John Doe">
                            </div>
                            
                            <div>
                                <label for="reg-phone" class="block text-sm font-medium text-gray-700">Singapore Mobile Number (8 digits)</label>
                                <input type="tel" id="reg-phone" 
                                       maxlength="8" 
                                       pattern="[89][0-9]{7}"
                                       title="Singapore mobile numbers must be 8 digits, starting with 8 or 9."
                                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                       placeholder="91234567">
                            </div>
                        </div>

                        <div>
                            <label for="reg-email" class="block text-sm font-medium text-gray-700">Email Address (Used for Login & Filtering)</label>
                            <input type="email" id="reg-email" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                   placeholder="your.email@example.com">
                        </div>

                        <div>
                            <label for="reg-password" class="block text-sm font-medium text-gray-700">Password (Min 6 Characters)</label>
                            <input type="password" id="reg-password" required 
                                   minlength="6"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                   placeholder="Create a password">
                        </div>
                        
                        <div>
                            <button type="submit" id="register-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                                Complete Registration
                            </button>
                            <!-- Updated Error Message Styling -->
                            <p id="register-status" class="mt-4 p-3 bg-red-100 border border-red-300 rounded-md text-sm text-red-800 font-semibold hidden"></p>
                        </div>
                    </form>
                    
                    <div class="mt-6 text-center">
                        <p class="text-sm text-gray-600">
                            Already have an account? 
                            <a href="#" id="show-login-link" class="font-medium text-indigo-600 hover:text-indigo-500">
                                Sign in here.
                            </a>
                        </p>
                    </div>
                </div>
                
            </div>

            <!-- Dashboard Container -->
            <div id="dashboard-container" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <h1 id="dashboard-header" class="text-3xl font-bold text-gray-900">Your Data Dashboard</h1>
                    <button id="refresh-button" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <!-- Cleaner Refresh Icon -->
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.357-2a8.001 8.001 0 0015.357 2m0 0H15" />
                        </svg>
                        Refresh Data
                    </button>
                </div>

                <!-- Action Button for Google Form -->
                <div class="mb-6">
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSeTFrDzuOh_0Gu248-bU92iDWJcWQhttaLgJ_lYbuaogSSFQA/viewform?usp=header" target="_blank" class="w-full inline-flex justify-center items-center px-6 py-3 border border-transparent text-lg font-bold rounded-lg shadow-md text-white bg-green-600 hover:bg-green-700 focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Clock Hours (Google Form)
                    </a>
                </div>

                
                <!-- Table Wrapper for scrolling -->
                <div id="table-wrapper" class="table-wrapper mt-4 bg-white shadow sm:rounded-lg overflow-hidden">
                    <!-- This div will hold the placeholder or the table -->
                    <div id="table-placeholder" class="p-6 text-center text-gray-500">
                        Loading data...
                    </div>
                    <!-- The table will be injected here by renderTable() -->
                </div>
            </div>

        </main>
    </div>

    <!-- Message Box -->
    <div id="message-box"
        class="fixed bottom-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-3"
        role="alert">
        <span id="message-text">This is an error message!</span>
    </div>


    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            // Imports for Email/Password Auth
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            deleteUser, // Keep for account deletion feature
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- CONFIGURATION ---
        
        // ** FIREBASE CONFIGURATION (USING CANVAS GLOBALS) **
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyB0XLeZIx1EAOAcjvvbrDh6jktRu7xeSGg",
            authDomain: "hrhs-volunteer-portal.firebaseapp.com",
            projectId: "hrhs-volunteer-portal",
            storageBucket: "hrhs-volunteer-portal.appspot.com",
            messagingSenderId: "818022267113",
            appId: "1:818022267113:web:fe383467efdef098045878",
            measurementId: "G-FY00GQCD7G"
};

        
        // Google Sheet URL (Published to web as CSV)
        const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTX2mCm37VJtcCheuTddiVO-7mQjIJjRC8S0uiZk8GF4NbNgHLq9exFUOpRljZ-Qa4jLECSFLRrbvZW/pub?output=csv";
        // A CORS proxy is needed to bypass browser security restrictions when fetching public CSV data
        const PROXY_URL = "https://corsproxy.io/?"; 

        // Columns to hide from the table. 
        const COLUMNS_TO_EXCLUDE = [
            "Timestamp", 
            "Name", 
            "Last 4 digits and characters of your Birth Cert / NRIC.",
            
        ];
        
        // Column to use for filtering rows. This MUST match a header in the sheet.
        const EMAIL_FILTER_COLUMN = "Email"; 
        
        // Columns for duration calculation
        const CHECK_IN_COLUMN = "Check-In Time";
        const CHECK_OUT_COLUMN = "Check-Out Time";
        const DURATION_COLUMN_NAME = "Duration (HH:MM)"; // New header name
        const DATE_COLUMN = "Date of volunteer activity"; // The column with the date

        // --- GLOBAL VARIABLES & INITIALIZATION ---
        
        if (!firebaseConfig || !firebaseConfig.apiKey) { // Added check for apiKey
            console.error("Firebase Configuration Error: Global __firebase_config is missing or invalid.");
             const authContainerElem = document.getElementById('auth-container');
             if (authContainerElem) {
                 authContainerElem.innerHTML = '<p class="text-red-600 text-center font-bold">Configuration Error: Cannot start application. Check console.</p>';
             }
        }

        // 1. Initialize Firebase App instance
        let app = firebaseConfig && firebaseConfig.apiKey ? initializeApp(firebaseConfig) : null;

        // 2. Initialize Auth and Firestore services
        let auth = app ? getAuth(app) : null;
        let db = app ? getFirestore(app) : null;
        
        let userIdentifierForFiltering = null; 
        let typedEmailForDisplay = null; // Use email again
        let typedNameForDisplay = null; 
        let autoRefreshIntervalId = null; 

        // --- DOM ELEMENTS (Declared Globally for broader access) ---
        let authContainer, loginView, registerView, dashboardContainer, logoutButtonContainer, logoutButton, deleteAccountButton, refreshButton, tablePlaceholder, dashboardHeader, loginForm, loginButton, authStatus, registerForm, registerButton, registerStatus, showRegisterLink, showLoginLink;
        
        /**
         * Shows a message to the user using the global message box elements.
         * @param {string} message - The text to display.
         * @param {boolean} [isError=true] - If true, show red error. If false, show green success.
         */
        function showMessage(message, isError = true) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            if (!messageBox || !messageText) {
                console.error("showMessage called before DOM elements are ready or elements are missing!");
                console.log(`Attempted message (${isError ? 'Error' : 'Success'}): ${message}`);
                return;
            }

            if (!message) {
                messageBox.style.display = "none";
                return;
            }
            messageBox.style.display = ""; // Show when there's a message

            messageText.textContent = message;
            messageBox.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl opacity-0 transform translate-y-3 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            setTimeout(() => {
                messageBox.classList.remove('opacity-0', 'translate-y-3');
                messageBox.classList.add('opacity-100', 'translate-y-0'); 
            }, 10);

            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-3');
            }, 5000);
        }

        /**
         * Initializes the application, gets DOM elements, and sets up listeners.
         */
        async function initialize() {
            // Get DOM Elements after DOM is loaded
            authContainer = document.getElementById('auth-container');
            loginView = document.getElementById('login-view');
            registerView = document.getElementById('register-view');
            dashboardContainer = document.getElementById('dashboard-container');
            logoutButtonContainer = document.getElementById('logout-button-container');
            logoutButton = document.getElementById('logout-button');
            deleteAccountButton = document.getElementById('delete-account-button'); 
            refreshButton = document.getElementById('refresh-button');
            tablePlaceholder = document.getElementById('table-placeholder');
            dashboardHeader = document.getElementById('dashboard-header');
            loginForm = document.getElementById('login-form');
            loginButton = document.getElementById('login-button'); // Re-added login button reference
            authStatus = document.getElementById('auth-status');
            registerForm = document.getElementById('register-form');
            registerButton = document.getElementById('register-button'); // Re-added register button reference
            registerStatus = document.getElementById('register-status');
            showRegisterLink = document.getElementById('show-register-link');
            showLoginLink = document.getElementById('show-login-link');

            try {
                setLogLevel('Debug');

                const projectId = firebaseConfig && firebaseConfig.projectId ? firebaseConfig.projectId : 'N/A';
                console.log("--- DEBUG INFO ---");
                console.log(`Canvas App ID (Tenancy): ${appId}`);
                console.log(`Firebase Project ID (for data storage): ${projectId}`);
                console.log(`Auth Token present: ${!!initialAuthToken}`); // Check if token exists
                console.log("------------------");
                console.log("Attempting to initialize with Email/Password. Ensure it's enabled in Firebase Console for Project ID: " + projectId);
                
                if (!auth) {
                    showMessage("Error: Firebase Authentication service failed to start.", true);
                    return;
                }
                
                // 3. Set up authentication state listener
                onAuthStateChanged(auth, async (user) => {
                    console.log("[AUTH] onAuthStateChanged triggered. User:", user ? user.uid : 'null', 'Is Anonymous:', user ? user.isAnonymous : 'N/A');
                    
                    if (user && !user.isAnonymous) {
                        // User is signed in with a permanent account (Email/Password).
                        console.log("[AUTH] Permanent user detected. Proceeding to load profile and dashboard.");
                        userIdentifierForFiltering = user.uid; 
                        
                        // Set email from the user object if available (for display fallback)
                        if (user.email) {
                            typedEmailForDisplay = user.email;
                        }
                        
                        await loadVolunteerProfile(); // Load name from Firestore
                        console.log("[AUTH] Calling showDashboard().");
                        showDashboard();
                    } else {
                        // User is signed out OR potentially signed in via the initial token (anonymous).
                        console.log("[AUTH] User is signed out or potentially anonymous. Forcing login page.");
                        userIdentifierForFiltering = null; // Clear any temporary ID
                        typedEmailForDisplay = null;
                        typedNameForDisplay = null; 
                        showAuthPage('login'); 
                    }
                });

                 // **Important:** Do NOT automatically sign in with token or anonymously here
                 // if we want the Email/Password flow to be primary. The listener above handles it.

            } catch (error) {
                console.error("Initialization Error:", error.message);
                showMessage("", false);
            }

            // Add event listeners for buttons
            if(logoutButton) logoutButton.addEventListener('click', handleLogout);
            if(deleteAccountButton) deleteAccountButton.addEventListener('click', handleDeleteAccount); 
            if(refreshButton) refreshButton.addEventListener('click', () => loadSheetData(true)); 
            
            // Re-added Email/Password Auth flow listeners
            if (loginForm) loginForm.addEventListener('submit', signInUser); // Changed from handleLoginSendOtp
            if (registerForm) registerForm.addEventListener('submit', handleRegistration); // Changed from handleRegisterSendOtp

            // View switch listeners remain the same
            if (showRegisterLink) showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); showAuthPage('register'); });
            if (showLoginLink) showLoginLink.addEventListener('click', (e) => { e.preventDefault(); showAuthPage('login'); });
        }
        
        /**
         * Switches between Login and Registration views.
         * @param {'login' | 'register'} view - The view to show.
         */
        function showAuthPage(view) {
             if (!authContainer || !dashboardContainer || !loginView || !registerView || !logoutButtonContainer) {
                console.error("showAuthPage: DOM elements not ready.");
                return;
            }
            authContainer.classList.remove('hidden');
            dashboardContainer.classList.add('hidden');
            
            // Only show the logout button container if a permanent user is signed in.
            const user = auth ? auth.currentUser : null;
            if (user && !user.isAnonymous) { 
                 logoutButtonContainer.classList.remove('hidden');
            } else {
                 logoutButtonContainer.classList.add('hidden');
            }

            // Reset Email/Password views
            if (view === 'login') {
                loginView.classList.remove('hidden');
                registerView.classList.add('hidden');
                if(authStatus) authStatus.classList.add('hidden'); 
                if(loginButton) loginButton.disabled = false; // Ensure button is enabled
                if(loginButton) loginButton.classList.remove('opacity-50');
            } else if (view === 'register') {
                loginView.classList.add('hidden');
                registerView.classList.remove('hidden');
                if(registerStatus) registerStatus.classList.add('hidden');
                if(registerButton) registerButton.disabled = false; // Ensure button is enabled
                if(registerButton) registerButton.classList.remove('opacity-50');
            }
            
            // Stop auto-refresh if it's running
            if (autoRefreshIntervalId) {
                clearInterval(autoRefreshIntervalId);
                autoRefreshIntervalId = null;
            }
        }

        // --- EMAIL/PASSWORD AUTH FLOW (Reinstated) ---

        /**
         * Handles the registration process: creates a new permanent account and saves the profile.
         */
        async function handleRegistration(event) {
            event.preventDefault();
            
            if (!db || !auth || !registerButton || !registerStatus) {
                showMessage("Registration error: Firebase services not available or DOM not ready.", true);
                return;
            }

            const fullNameInput = document.getElementById('reg-full-name');
            const emailInput = document.getElementById('reg-email');
            const passwordInput = document.getElementById('reg-password');
            const phoneInput = document.getElementById('reg-phone');

            const fullName = fullNameInput ? fullNameInput.value.trim() : '';
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value.trim() : '';
            const phone = phoneInput ? phoneInput.value.trim() : '';
            
            // Client-side validation
            const phoneRegex = /^[89][0-9]{7}$/;
            if (phone && !phoneRegex.test(phone)) {
                registerStatus.textContent = "Error: Please enter a valid 8-digit Singapore mobile number starting with 8 or 9.";
                registerStatus.classList.remove('hidden');
                registerStatus.classList.add('text-red-800', 'bg-red-100', 'border-red-300', 'p-3', 'rounded-md', 'font-semibold');
                return;
            }
            if (!email || !fullName || !password) {
                showMessage("Full Name, Email, and Password are required for registration.", true);
                return;
            }
             if (password.length < 6) {
                 registerStatus.textContent = "Password must be at least 6 characters long.";
                 registerStatus.classList.remove('hidden');
                 registerStatus.classList.add('text-red-800', 'bg-red-100', 'border-red-300', 'p-3', 'rounded-md', 'font-semibold');
                 return;
            }

            // Simulate loading state
            registerButton.disabled = true;
            registerButton.classList.add('opacity-50');
            registerStatus.textContent = "Creating account and saving profile...";
            registerStatus.classList.remove('hidden', 'text-red-800', 'bg-red-100', 'border-red-300');
            registerStatus.classList.add('text-gray-500', 'bg-gray-100', 'border-gray-300', 'p-3', 'rounded-md', 'font-semibold');

            try {
                // Force sign out of any prior anonymous/token user
                 if (auth.currentUser) {
                    console.log("[AUTH] Signing out existing user before registration attempt...");
                    await signOut(auth);
                 }
                console.log(`[AUTH] Attempting createUserWithEmailAndPassword for: ${email}`);
                
                // --- STEP 1: Create Permanent Firebase User Account ---
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const newUser = userCredential.user;
                console.log(`[AUTH] User created successfully. UID: ${newUser.uid}`);
                
                // --- STEP 2: Save Profile Data to Firestore using the new UID ---
                const profileRef = doc(
                    db, 
                    `artifacts/${appId}/users/${newUser.uid}/volunteer_profiles`, 
                    'profile'
                );

                const profileData = {
                    fullName: fullName,
                    email: email, // Save the email used for registration
                    phone: phone,
                    registeredAt: new Date().toISOString()
                };

                await setDoc(profileRef, profileData);
                console.log("[FIRESTORE] Profile successfully created and saved.");

                // Update display state immediately
                typedNameForDisplay = fullName;
                typedEmailForDisplay = email;
      userIdentifierForFiltering = userCredential.user.uid; 

                showMessage(`Registration complete! Welcome, ${fullName}. You are now signed in.`, false);
                
                // Clear form - onAuthStateChanged will handle the dashboard view
                if (registerForm) registerForm.reset();
                registerStatus.classList.add('hidden');
                
            } catch (error) {
                console.error("[AUTH] Registration Failed:", error);
                
                let errorMessage = "Registration Failed: ";
                const projectIdUsed = firebaseConfig && firebaseConfig.projectId ? firebaseConfig.projectId : 'N/A';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email is already registered. Please sign in instead.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak. Please use at least 6 characters.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = `The **Email/Password sign-in method** is **DISABLED** for Firebase Project ID **${projectIdUsed}**. Please ensure it is enabled in the Firebase Console under **Authentication** > **Sign-in method** for this specific project. (Code: ${error.code})`;
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "The email address provided is not valid.";
                } else {
                    errorMessage = `${error.message} (Code: ${error.code})`;
                }

                registerStatus.innerHTML = errorMessage; // Use innerHTML to render bold tags
                registerStatus.classList.remove('text-gray-500', 'bg-gray-100', 'border-gray-300');
                registerStatus.classList.add('text-red-800', 'bg-red-100', 'border-red-300', 'p-3', 'rounded-md', 'font-semibold');
                registerStatus.classList.remove('hidden');
                registerButton.disabled = false;
                registerButton.classList.remove('opacity-50');
            }
        }

        /**
         * Signs the user in using email and password.
         * @param {Event} event - The form submission event.
         */
        async function signInUser(event) {
            event.preventDefault(); // Prevent default form submission
            
            if (!auth || !loginButton || !authStatus) {
                 if (typeof showMessage === 'function') {
                    showMessage("Login error: Firebase services not available or DOM not ready.", true);
                 } else {
                     console.error("Login error: Firebase services not available or DOM not ready.");
                 }
                 return;
            }

            // 1. Capture credentials
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value.trim() : '';
            
            console.log(`[AUTH] Attempting sign in for: ${email}`); 

            // Show logging in status
            loginButton.disabled = true;
            loginButton.classList.add('opacity-50');
            authStatus.textContent = "Signing in...";
            authStatus.classList.remove('hidden');
            
            try {
                 // Force sign out of any prior anonymous/token user
                 if (auth.currentUser) {
                    console.log("[AUTH] Signing out existing user before login attempt...");
                    await signOut(auth);
                 }
                console.log(`[AUTH] Attempting signInWithEmailAndPassword for: ${email}`);

                // 2. Perform Standard Email/Password Sign-In
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log(`[AUTH] Sign in successful. User UID: ${userCredential.user.uid}`); 
                
                // Set the email for filtering immediately
                typedEmailForDisplay = email; 
                userIdentifierForFiltering = userCredential.user.uid;

                // 3. Load Name from Firestore
                await loadVolunteerProfile(); 
                
                showMessage("Authentication successful. Loading dashboard...", false);
                
                // NOTE: onAuthStateChanged will handle the dashboard transition.

            } catch (error) {
                console.error("[AUTH] Sign In Error:", error); 
                
                // Restore button state
                loginButton.disabled = false;
                loginButton.classList.remove('opacity-50');
                typedEmailForDisplay = null; 
                typedNameForDisplay = null; 

                let errorMessage = `Login Failed: Invalid credentials or account not found.`;
                const projectIdUsed = firebaseConfig && firebaseConfig.projectId ? firebaseConfig.projectId : 'N/A';
                
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Login Failed: Invalid email or password.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = `Login Failed: The **Email/Password sign-in method** is **DISABLED** for Firebase Project ID **${projectIdUsed}**. Please ensure it is enabled in the Firebase Console. (Code: ${error.code})`;
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "The email address provided is not valid.";
                } else {
                    errorMessage = `Login Failed: ${error.message} (Code: ${error.code})`; // Fallback for other errors
                }

                authStatus.innerHTML = errorMessage; // Use innerHTML for bold tags
                authStatus.classList.remove('hidden');
                
                if (typeof showMessage === 'function') {
                    showMessage(errorMessage, true);
                } else {
                    console.error("showMessage function is not available to display login error.");
                }
            }
        }
        
        // --- END OF EMAIL/PASSWORD AUTH FLOW ---


        // --- DASHBOARD FUNCTIONS ---

        /**
         * Loads the user's saved profile name from Firestore.
         */
        async function loadVolunteerProfile() {
            console.log("[AUTH] Attempting to load profile..."); 
            if (!db || !userIdentifierForFiltering) {
                console.log("[AUTH] Profile load skipped: No DB or user ID."); 
                typedNameForDisplay = null;
                // Keep typedEmailForDisplay from login attempt
                return;
            }

            try {
                const profileRef = doc(
                    db, 
                    `artifacts/${appId}/users/${userIdentifierForFiltering}/volunteer_profiles`, 
                    'profile'
                );
                
                const docSnap = await getDoc(profileRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    typedNameForDisplay = data.fullName || null;
                    // Overwrite email with the one stored in profile if available
                    if (data.email) typedEmailForDisplay = data.email; 
                    console.log(`[AUTH] Profile loaded from Firestore: Name=${typedNameForDisplay}, Email=${typedEmailForDisplay}`);
                    showDashboard();
                } else {
                    typedNameForDisplay = null;
                    // Keep typedEmailForDisplay from login attempt
                    console.log("[AUTH] No volunteer profile found in Firestore for this user.");
                }
            } catch (error) {
                console.error("[AUTH] Error loading profile from Firestore:", error);
                typedNameForDisplay = null;
                // Keep typedEmailForDisplay from login attempt
            }
        }

        /**
         * Handles user logout.
         */
        async function handleLogout() {
            if (!auth) return;
            try {
                await signOut(auth);
                // No need for message, onAuthStateChanged handles UI update
            } catch (error) {
                console.error("Logout Error:", error);
                showMessage(`Logout Failed: ${error.message}`, true);
            }
        }
        
        /**
         * Handles deleting the current user's account.
         */
        async function handleDeleteAccount() {
            if (!auth || !auth.currentUser) {
                showMessage("Error: Not signed in.", true);
                return;
            }

            const user = auth.currentUser;
            if (user.isAnonymous) {
                showMessage("Error: Cannot delete anonymous session.", true);
                return;
            }
            
            const confirmation = prompt(`Type 'DELETE' to permanently delete your account (${user.email || 'user'}). This cannot be undone.`);
            
            if (confirmation !== 'DELETE') {
                showMessage("Account deletion cancelled.", false);
                return;
            }

            try {
                // Delete Firestore profile first (optional but good practice)
                 const profileRef = doc(
                    db, 
                    `artifacts/${appId}/users/${user.uid}/volunteer_profiles`, 
                    'profile'
                );
                 // Note: Firebase client SDKs typically cannot delete documents directly.
                 // For now, we just delete the auth user. A Cloud Function is needed for full cleanup.

                // Delete the Firebase User
                await deleteUser(user);
                showMessage("Account successfully deleted. Please refresh the page to view changes.", false);
            } catch (error) {
                console.error("Delete Account Error:", error);
                let msg = `Error: ${error.message}`;
                if (error.code === 'auth/requires-recent-login') {
                    msg = "Error: This is a sensitive operation. Please log out and log back in before deleting your account.";
                }
                showMessage(msg, true);
            }
        }

        /**
         * Shows the main dashboard view and kicks off data loading.
         */
        function showDashboard() {
             if (!authContainer || !dashboardContainer || !dashboardHeader || !logoutButtonContainer) {
                console.error("showDashboard: DOM elements not ready.");
                return;
            }
            console.log("[AUTH] Executing showDashboard()."); 
            authContainer.classList.add('hidden');
            dashboardContainer.classList.remove('hidden');
            logoutButtonContainer.classList.remove('hidden');

            const name = typedNameForDisplay || (typedEmailForDisplay ? typedEmailForDisplay.split('@')[0] : "Volunteer");
            dashboardHeader.textContent = `Welcome, ${name}!`;
            console.log(`[AUTH] Dashboard header set to: Welcome, ${name}!`); 

            // Start loading the sheet data immediately
            loadSheetData(true); 
            
            // Set up auto-refresh every 2 minutes (120000 ms)
            if (autoRefreshIntervalId) {
                clearInterval(autoRefreshIntervalId);
            }
            autoRefreshIntervalId = setInterval(() => loadSheetData(false), 120000);
        }


        /**
         * Fetches data from Google Sheet and triggers render.
         * (Google Sheet functions remain largely unchanged)
         */
        async function loadSheetData(isManualRefresh = false) {
             if (!refreshButton || !tablePlaceholder) {
                console.error("loadSheetData: DOM elements not ready.");
                return;
            }
            refreshButton.disabled = true;
            refreshButton.classList.add('opacity-50');
            
            tablePlaceholder.innerHTML = `<p class="text-center p-8 text-gray-500 italic flex justify-center items-center"><span class="animate-spin mr-2 h-5 w-5 border-4 border-gray-200 border-t-indigo-600 rounded-full"></span> Loading data...</p>`;
            
            const urlToFetch = PROXY_URL + encodeURIComponent(GOOGLE_SHEET_URL);

            try {
                const response = await fetch(urlToFetch);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}, StatusText: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                const data = parseCSV(csvText);
                renderTable(data);
                
                if (isManualRefresh) {
                    showMessage("Data refreshed successfully!", false);
                }

            } catch (error) {
                console.error("Error fetching Google Sheet:", error);
                const errorMessage = `Error fetching data: ${error.message}. Check sheet URL and permissions.`;
                showMessage(errorMessage, true);
                if (tablePlaceholder) {
                     tablePlaceholder.innerHTML = `<p class="text-center p-8 text-red-500">${errorMessage}</p>`;
                }
            } finally {
                if (refreshButton) {
                    refreshButton.disabled = false;
                    refreshButton.classList.remove('opacity-50');
                }
            }
        }

        /**
         * Parses CSV text into an array of objects, filtering by email.
         * (Google Sheet functions remain largely unchanged)
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return []; 

            const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                .map(h => h.trim().replace(/"/g, ''));
            
            const emailFilterIndex = headers.findIndex(h => h.toLowerCase() === EMAIL_FILTER_COLUMN.toLowerCase());
            
            if (emailFilterIndex === -1 && typedEmailForDisplay) {
                console.warn(`Filter column "${EMAIL_FILTER_COLUMN}" not found in sheet headers.`);
            }

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                    .map(v => v.trim().replace(/^"|"$/g, '').replace(/""/g, '"')); 

                if (values.length !== headers.length) {
                     console.warn(`Skipping malformed row ${i + 1}: Expected ${headers.length} columns, found ${values.length}`);
                     continue; 
                }

                // Filtering Logic: Filter by the email used for login/registration
                let passesFilter = false;
                if (!typedEmailForDisplay) {
                     // If no email context (e.g., initial load issue?), show nothing to be safe
                     passesFilter = false; 
                } else if (emailFilterIndex !== -1) {
                    const emailInSheet = values[emailFilterIndex] ? values[emailFilterIndex].trim().toLowerCase() : '';
                    if (emailInSheet === typedEmailForDisplay.toLowerCase()) {
                        passesFilter = true;
                    }
                } else {
                     // If Email column doesn't exist, show no data for this user
                     passesFilter = false;
                }


                if (passesFilter) {
                    let rowObject = {};
                    headers.forEach((header, index) => {
                        rowObject[header] = values[index];
                    });
                    data.push(rowObject);
                }
            }
            return data;
        }

        /**
         * Renders the data array into an HTML table.
         * (Google Sheet functions remain largely unchanged)
         */
        function renderTable(data) {
            const tableContainer = document.getElementById('table-wrapper');
            if (!tableContainer) return;

            if (data.length === 0) {
                 const filterText = typedEmailForDisplay ? ` for "${typedEmailForDisplay}"` : '';
                 tableContainer.innerHTML = `<p class="text-center p-8 text-gray-500 italic">No volunteer activity found${filterText}.</p>`;
                return;
            }

            const headers = Object.keys(data[0]);

            const checkInIndex = headers.findIndex(h => h.toLowerCase() === CHECK_IN_COLUMN.toLowerCase());
            const checkOutIndex = headers.findIndex(h => h.toLowerCase() === CHECK_OUT_COLUMN.toLowerCase());
            const dateIndex = headers.findIndex(h => h.toLowerCase() === DATE_COLUMN.toLowerCase());

            const displayedHeaders = headers.filter(header => {
                if (COLUMNS_TO_EXCLUDE.map(h => h.toLowerCase()).includes(header.toLowerCase())) return false;
                // Remove these lines below
                // if (checkInIndex !== -1 && checkOutIndex !== -1) {
                //   if (header.toLowerCase() === CHECK_IN_COLUMN.toLowerCase()) return false;
                //   if (header.toLowerCase() === CHECK_OUT_COLUMN.toLowerCase()) return false;
                // }
                return true;
            });


            /* if (checkInIndex !== -1 && checkOutIndex !== -1) {
                displayedHeaders.push(DURATION_COLUMN_NAME);
            } */

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-300';
            
            const thead = table.createTHead();
            thead.className = 'bg-gray-50';
            const headerRow = thead.insertRow();
            displayedHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.className = 'px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider';
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            tbody.className = 'bg-white divide-y divide-gray-200';

            data.forEach((row, rowIndex) => {
                const tr = tbody.insertRow();
                tr.className = rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'; 

                let duration = "N/A";
                if (checkInIndex !== -1 && checkOutIndex !== -1) {
                    const dateStr = dateIndex !== -1 ? row[headers[dateIndex]] : null;
                    const checkInStr = row[headers[checkInIndex]];
                    const checkOutStr = row[headers[checkOutIndex]];
                    duration = formatDuration(checkInStr, checkOutStr, dateStr);
                }

                displayedHeaders.forEach(header => {
                    const td = tr.insertCell();
                    td.className = 'px-4 py-3 text-sm text-gray-700 whitespace-nowrap';
                    if (header === DURATION_COLUMN_NAME) {
                        td.textContent = duration;
                    } else {
                        td.textContent = row[header] || '';
                    }
                });
            });
            
            tableContainer.innerHTML = ''; 
            tableContainer.appendChild(table);
        }

        /**
         * Calculates duration between two time strings.
         * (Google Sheet functions remain largely unchanged)
         */
        function formatDuration(checkInStr, checkOutStr, dateStr) {
            if (!checkInStr || !checkOutStr) return "N/A";

            try {
                let baseDate = "2000-01-01"; 
                if (dateStr) {
                    const parts = dateStr.split('/');
                    if (parts.length === 3 && parseInt(parts[2]) > 1900 && parseInt(parts[1]) > 0 && parseInt(parts[1]) < 13 && parseInt(parts[0]) > 0 && parseInt(parts[0]) < 32) {
                        baseDate = `${parts[2]}-${String(parts[1]).padStart(2, '0')}-${String(parts[0]).padStart(2, '0')}`;
                    } else {
                         console.warn(`Invalid date format encountered: ${dateStr}. Using default date.`);
                    }
                }
                
                const checkIn = parseFlexibleTime(checkInStr, baseDate);
                const checkOut = parseFlexibleTime(checkOutStr, baseDate);
                
                if (!checkIn || !checkOut) return "N/A";

                let diffMs = checkOut.getTime() - checkIn.getTime();
                if (diffMs < 0) {
                     console.warn(`Check-out time (${checkOutStr}) appears to be before check-in time (${checkInStr}) on ${baseDate}.`);
                     return "N/A (Invalid Times?)";
                }

                let totalMinutes = Math.floor(diffMs / 60000);
                let hours = Math.floor(totalMinutes / 60);
                let minutes = totalMinutes % 60;
                
                const paddedHours = String(hours).padStart(2, '0');
                const paddedMinutes = String(minutes).padStart(2, '0');
                
                return `${paddedHours}:${paddedMinutes}`;
                
            } catch (error) {
                console.error("Error formatting duration:", error, {checkInStr, checkOutStr});
                return "Error";
            }
        }

        /**
         * Parses time.
         * (Google Sheet functions remain largely unchanged)
         */
        function parseFlexibleTime(timeStr, baseDate) {
            if (!timeStr) return null;

            timeStr = timeStr.replace('上午', 'AM').replace('下午', 'PM');
            timeStr = timeStr.replace(/\s+/g, ' ').trim();
            
            const dateTimeStrSpace = `${baseDate} ${timeStr}`;
            const dateTimeStrT = `${baseDate}T${timeStr}`; 

            let date = new Date(dateTimeStrSpace);
            
            if (isNaN(date.getTime())) {
                date = new Date(dateTimeStrT);
            }
            
            if (isNaN(date.getTime()) && /^\d{1,2}:\d{2}:\d{2}$/.test(timeStr)) {
                 const timeParts = timeStr.split(':');
                 const isoTimeStr = `${String(timeParts[0]).padStart(2, '0')}:${timeParts[1]}:${timeParts[2]}`;
                 const dateTimeStr24 = `${baseDate}T${isoTimeStr}`;
                 const date24 = new Date(dateTimeStr24);
                 if (!isNaN(date24.getTime())) {
                    return date24;
                 }
            }

            if (isNaN(date.getTime())) {
                console.warn(`Failed to parse time string: "${timeStr}" with base date "${baseDate}"`);
                return null;
            }

            return date;
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', initialize);

    </script>
</body>
</html>

